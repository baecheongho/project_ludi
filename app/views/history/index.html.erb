<!DOCTYPE html>
<html lang="en">

<%= stylesheet_link_tag 'css/nucleo-icons.css', media: 'all', 'data-turbolinks-track' => true %>
<%= stylesheet_link_tag 'css/dashboard-main.css', media: 'all', 'data-turbolinks-track' => true %>
<%= stylesheet_link_tag 'history', media: 'all', 'data-turbolinks-track' => true %>
<%= stylesheet_link_tag 'bootstrap-material-datetimepicker.min.css', media: 'all', 'data-turbolinks-track' => true %>

<!--   Core JS Files   -->
<link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
<%= javascript_include_tag "other/perfect-scrollbar.jquery.min" %>

<%= javascript_include_tag "other/bootstrap-notify.js" %>
<%= javascript_include_tag "dashboard-main.js" %>
<%= javascript_include_tag "chart.js" %>


<script src="assets/chart2.js"></script>
<script src="assets/dashboard.js"></script>
<script src="assets/jquery-3.4.1.min.js"></script>
<script src="assets/jquery-ui.js"></script>
<script src="assets/popper.min.js"></script>
<script src="assets/bootstrap.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>



<%= javascript_include_tag "moment-with-locales.js" %>
<%= javascript_include_tag "bootstrap-material-datetimepicker.min.js" %>







<%= javascript_include_tag "dashboard.js" %>
<%= javascript_include_tag "dashboard-func.js" %>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/apple-icon.png">
    <link rel="icon" type="image/svg" href="../assets/favicon.svg">

    <title>
      LUDI-APM
    </title>
    <!-- Fonts and icons -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet"/>

  </head>

  <body class="" data-turbolinks="false">
    <div class="wrapper">
      <div class="sidebar">
        <!-- Tip 1: You can change the color of the sidebar using: data-color="blue | green | orange | red" -->
        <div class="sidebar-wrapper">
          <div class="logo">
            <a href="javascript:void(0)" class="simple-text logo-mini">
              <img src="assets/ludi_logo.svg"></img>
            </a>
            <a href="javascript:void(0)" class="simple-text logo-normal">
              LUDI-APM v.1
            </a>
          </div>
          <ul class="nav">
            <li>
              <a href="dashboard">
                <i class="tim-icons icon-chart-pie-36"></i>

                <p>대시보드</p>
              </a>
            </li>
            <li>
              <a href="./sub_item">
                <i class="tim-icons icon-chart-bar-32"></i>
                <p>서브 대시보드</p>
              </a>
            </li>
            <li>
              <a href="./net_map">
                <i class="tim-icons icon-pin"></i>
                <p>네트워크 맵(준비중)</p>
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities" aria-expanded="false" aria-controls="collapseUtilities">
                <i class="tim-icons icon-bell-55"></i>
                <p>알림 & 임계치 설정</p>
              </a>

              <div id="collapseUtilities" class="collapse">

                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <a sytle="text-align: center;" class="collapse-item" href="th_infra">
                  <font text-align="right" size="1em" color="white">
                    인프라 모니터링</font>
                </a><br>

                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <a class="collapse-item" href="th_app">
                  <font size="1em" color="white">
                    > 알림 채널</font>
                </a><br>

              </div>
            </li>


            <li class="active">
              <a href="event_history">
                <i class="tim-icons icon-double-left"></i>
                <p>이벤트 히스토리</p>
              </a>
            </li>

            <li>
              <a href="register">
                <i class="tim-icons icon-bullet-list-67"></i>
                <p>모니터링 등록 및 관리</p>
              </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <li>
              <a href="./guide">
                <i class="tim-icons icon-paper"></i>
                <p>가이드</p>
              </a>
            </li>
            <li>
              <a href="./report">
                <i class="tim-icons icon-single-copy-04"></i>
                <p>보고서</p>
              </a>
            </li>
            <li></li>
          </ul>
        </div>
      </div>
      <div class="main-panel">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-absolute navbar-transparent">
          <div class="container-fluid">
            <div class="navbar-wrapper">
              <div class="navbar-toggle d-inline">
                <button type="button" class="navbar-toggler">
                  <span class="navbar-toggler-bar bar1"></span>
                  <span class="navbar-toggler-bar bar2"></span>
                  <span class="navbar-toggler-bar bar3"></span>
                </button>
              </div>
              <a class="navbar-brand" href="/dashboard">
                <img src="assets/report_logo.png" width="70%"></img>

              </a>
            </div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-bar navbar-kebab"></span>
              <span class="navbar-toggler-bar navbar-kebab"></span>
              <span class="navbar-toggler-bar navbar-kebab"></span>
            </button>
            <div class="collapse navbar-collapse" id="navigation">
              <ul class="navbar-nav ml-auto">

                <li class="dropdown nav-item">
                  <a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown">
                    <div class="photo">
                      <i class="tim-icons icon-single-02"></i>
                    </div>
                    <b class="caret d-none d-lg-block d-xl-block"></b>
                    <p class="d-lg-none">
                      로그 아웃
                    </p>
                  </a>
                  <ul class="dropdown-menu dropdown-navbar">
                    <li class="nav-link">
                      <a href="javascript:void(0)" class="nav-item dropdown-item">프로필</a>
                    </li>
                    <li class="nav-link">
                      <a href="javascript:void(0)" class="nav-item dropdown-item">셋팅</a>
                    </li>
                    <li class="dropdown-divider"></li>
                    <li class="nav-link">
                      <a href="javascript:void(0)" class="nav-item dropdown-item">로그 아웃</a>
                    </li>
                  </ul>
                </li>
                <li class="separator d-lg-none"></li>
              </ul>
            </div>
          </div>
        </nav>
        <div class="modal modal-search fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModal" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <input type="text" class="form-control" id="inlineFormInputGroup" placeholder="SEARCH">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <i class="tim-icons icon-simple-remove"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- End Navbar -->



        <div class="content">
          <div class="col-md-13">
            <div class="card">
              <div class="card-body">
                <!-- sub title -->

                <div class="row">
                  <div class="col-md-12 ml-auto mr-auto text-center">
                    <div class="card-header">
                      <h4 class="card-title">
                        <strong>
                          Event History [ 이벤트 현황 ]</strong>

                      </h4>
                    </div>
                  </div>
                </div>
                <!-- sub title end-->

              </div>
            </div>
          </div>




          <div class="col-md-13">
            <div class="card">
              <div class="card-body">
                <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

                <script>
                    $(function () {
                        $('#date_from,#date_to').bootstrapMaterialDatePicker({
                            format: 'YYYY-MM-DD HH:mm'
                        });
                    });
                </script>

                      <%= form_tag "event_history", method: :post do %>
                <div class="row">

                  <div class="col-md-3 py-2" id="date-time-picker1" >
                    <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                        <input id="date_from" name="date_from" type="text" class="form-control " placeholder="시작 시점 선택" data-target="#datetimepicker1"/>
                        <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">

                        </div>
                    </div>
                  </div>

                  <div class="col-md-3 py-2" id="date-time-picker2" >
                    <div class="input-group date" id="datetimepicker2" data-target-input="nearest">
                        <input id="date_to" name="date_to" type="text" class="form-control datetimepicker-input" placeholder="종료 시점 선택" data-target="#datetimepicker2"/>
                        <div class="input-group-append" data-target="#datetimepicker2" data-toggle="datetimepicker">

                        </div>
                    </div>
                  </div>

                  <div class="col-md-1">
                    <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                        <input class="btn btn-primary" type="submit" value="적용">
                    </div>
                  </div>

                </div>

                <% if params[:date_from].present? && params[:date_to].present? %>
                  <script>
                    //alert('<%= params[:date_from] %>')
                  </script>

                  <% else %>
                  <script>
                    //alert('시간을 선택 하세요.')
                  </script>
                <% end %>
                <% end %>

                        </div>
                    </div>
                  </div>

<!-- End DateTime picker -->



            <div class="row">
              <div class="col">
                <div class="card">

                  <!-- problem triggers -->
                  <div class="row">
                    <div class="col resizable">
                      <div class="card">
                        <div class="card-header">
                          <h4 class="card-title">
                              <%=  @date_from_unixt_str %> &nbsp;&nbsp;&nbsp;~&nbsp;&nbsp;&nbsp; <%= @date_to_unixt_str %> 까지  </h4>
                        </div>


                        <div class="card-body">
                          <div class="table-responsive" name="event_history_div" style="width:100%; height:440px; overflow:auto">
                            <table id="event_history" class="table table sorter ">
                              <thead class=" text-primary">

                                <tbody>

                                  <th>
                                    <font color="gray">
                                      호스트
                                    </font>
                                  </th>
                                  <th class="text-center">
                                    <font color="gray">
                                      Serverity (등급)
                                    </font>
                                  </th>
                                  <th>
                                    <font color="gray">
                                      Status (현재 상태)</font>
                                  </th>
                                  <th>
                                    <font color="gray">
                                      Event trigger (이벤트 명)</font>
                                  </th>
                                  <th>
                                    <font color="gray">
                                      Age (발생후 지난시간)</font>
                                  </th>
                                  <th>
                                    <font color="gray">
                                      Time (발생 시점)</font>

                                  </th>

                                  <% @event_history.each do |t| %>

                                    <tr>

                                      <td>
                                        <% host = t.select{|x| x["host"]} %>

                                          <% host_val_json = host.to_json %>
                                          <% host_val = host_val_json.scan(/(?<=host":").*[a-zA-Z0-9]/) %>
                                          <%= host_val[0] %>

                                            </td>
                                            <td >
                                              <% severity = t.select{|x| x["severity"]} %>
                                              <% severity_str = severity.to_s %>
                                              <% severity_sort = severity_str.gsub!(/[^0-9]/, ' ') %>
                                              <% severity_int = severity_sort.to_i %>
                                                      <% case severity_int %>
                                                        <% when 0 %>
                                                          <font color="gray">
                                                            <strong>
                                                              등급 없음
                                                              <strong></font>

                                                              <% when 1 %>

                                                                <font color="gray">
                                                                  <strong>
                                                                    보통
                                                                    <strong></font>

                                                                    <% when 2 %>

                                                                      <font color="gray">
                                                                        <strong>
                                                                          관심
                                                                          <strong></font>

                                                                          <% when 3 %>

                                                                            <font color="orange">
                                                                              <strong>
                                                                                주의
                                                                                <strong></font>

                                                                                <% when 4 %>

                                                                                  <font color="#FF4501">
                                                                                    <strong>
                                                                                      경고
                                                                                      <strong></font>

                                                                                      <% when 5 %>

                                                                                        <font color="red">
                                                                                          <strong>
                                                                                            심각
                                                                                            <strong></font>

                                                                                          <% end %>

                                                                                        </td>
                                                                                        <td>
                                                                                          <% status = t.select{|x| x["value"]} %>
                                                                                            <% status_str = status.to_s %>
                                                                                              <% status_sort = status_str.gsub!(/[^0-9]/, ' ') %>
                                                                                                <% status_int = status_sort.to_i %>
                                                                                                  <% case status_int %>
                                                                                                    <% when 0 %>
                                                                                                      <font color="green">
                                                                                                        OK
                                                                                                      </font>
                                                                                                      <i class="fa fa-check-circle" style="color:green"></i>
                                                                                                      <% when 1 %>
                                                                                                        <i class="fa fa-exclamation-circle" style="color:yellow"></i>
                                                                                                        <font color="red">
                                                                                                          PROBLEM (문제 발생)
                                                                                                        </font>

                                                                                                      <% end %>

                                                                                                    </td>

                                                                                                    <td>
                                                                                                      <% name = t.select{|x| x["name"]} %>
                                                                                                        <% name_val_json = name.to_json %>
                                                                                                          <% name_val = name_val_json.scan(/(?<=name":").*[a-zA-Z0-9]/) %>
                                                                                                            <%= name_val[0]%>

                                                                                                          </td>

                                                                                                          <td>
                                                                                                            <% age_val = t.select{|x| x["clock"]} %>
                                                                                                              <% age_val_str = age_val.to_s %>
                                                                                                                <% remove_spc = age_val_str.gsub!(/[^0-9]/, ' ') %>
                                                                                                                  <% age_val_int = remove_spc.to_i %>
                                                                                                                    <% Time.at(age_val_int) %>
                                                                                                                      <%= time_ago_in_words(age_val_int, include_seconds: true)%>

                                                                                                                    </td>

                                                                                                                    <td>
                                                                                                                      <% unix_time_val = t.select{|x| x["clock"]} %>
                                                                                                                        <% unix_time_val_str = unix_time_val.to_s %>
                                                                                                                          <% remove_spc = unix_time_val_str.gsub!(/[^0-9]/, ' ') %>
                                                                                                                            <% unix_time_val_int = remove_spc.to_i %>
                                                                                                                              <%= Time.at(unix_time_val_int) %>
                                                                                                                            </td>

                                                                                                                          </tr>
                                                                                                                        <% end %>

                                                                                                                      </tbody>
                                                                                                                    </table>
                                                                                                                  </div>
                                                                                                                </div>
                                                                                                              </div>
                                                                                                            </div>


                                                                                                          </div>

                                                                                                          <ul class="pagination">

                                                                                                          </ul>

                                                                                                        </div>


                                                                                                        <div class="fixed-plugin">
                                                                                                          <div class="dropdown show-dropdown">

                                                                                                            <a href="#" data-toggle="dropdown">
                                                                                                              <i class="fa fa-cog fa-2x"></i>
                                                                                                            </a>

                                                                                                            <ul class="dropdown-menu">
                                                                                                              <li class="header-title">
                                                                                                                사이드바 테마 선택</li>
                                                                                                              <li class="adjustments-line">
                                                                                                                <a href="javascript:void(0)" class="switch-trigger background-color">
                                                                                                                  <div class="badge-colors text-center">
                                                                                                                    <span class="badge filter badge-primary active" data-color="primary"></span>
                                                                                                                    <span class="badge filter badge-info" data-color="blue"></span>
                                                                                                                    <span class="badge filter badge-success" data-color="green"></span>
                                                                                                                  </div>
                                                                                                                  <div class="clearfix"></div>
                                                                                                                </a>
                                                                                                              </li>
                                                                                                              <li class="adjustments-line text-center color-change">
                                                                                                                <span class="color-label">White 테마</span>
                                                                                                                <span class="badge light-badge mr-2"></span>
                                                                                                                <span class="badge dark-badge ml-2"></span>
                                                                                                                <span class="color-label">DARK 테마</span>
                                                                                                              </li>

                                                                                                              <li class="header-title">LUDI-APM</li>
                                                                                                              <li class="button-container text-center">
                                                                                                                <br>
                                                                                                                <br>

                                                                                                              </li>
                                                                                                            </ul>
                                                                                                          </div>
                                                                                                        </div>

                                                                                                        <script>
                                                                                                          $(document).ready(function () {
                                                                                                            $().ready(function () {
                                                                                                              $sidebar = $('.sidebar');
                                                                                                              $navbar = $('.navbar');
                                                                                                              $main_panel = $('.main-panel');

                                                                                                              $full_page = $('.full-page');

                                                                                                              $sidebar_responsive = $('body > .navbar-collapse');
                                                                                                              sidebar_mini_active = true;
                                                                                                              white_color = false;

                                                                                                              window_width = $(window).width();

                                                                                                              fixed_plugin_open = $('.sidebar .sidebar-wrapper .nav li.active a p').html();

                                                                                                              $('.fixed-plugin a').click(function (event) {
                                                                                                                if ($(this).hasClass('switch-trigger')) {
                                                                                                                  if (event.stopPropagation) {
                                                                                                                    event.stopPropagation();
                                                                                                                  } else if (window.event) {
                                                                                                                    window.event.cancelBubble = true;
                                                                                                                  }
                                                                                                                }
                                                                                                              });

                                                                                                              $('.fixed-plugin .background-color span').click(function () {
                                                                                                                $(this).siblings().removeClass('active');
                                                                                                                $(this).addClass('active');

                                                                                                                var new_color = $(this).data('color');

                                                                                                                if ($sidebar.length != 0) {
                                                                                                                  $sidebar.attr('data', new_color);
                                                                                                                }

                                                                                                                if ($main_panel.length != 0) {
                                                                                                                  $main_panel.attr('data', new_color);
                                                                                                                }

                                                                                                                if ($full_page.length != 0) {
                                                                                                                  $full_page.attr('filter-color', new_color);
                                                                                                                }

                                                                                                                if ($sidebar_responsive.length != 0) {
                                                                                                                  $sidebar_responsive.attr('data', new_color);
                                                                                                                }
                                                                                                              });

                                                                                                              $('.switch-sidebar-mini input').on("switchChange.bootstrapSwitch", function () {
                                                                                                                var $btn = $(this);

                                                                                                                if (sidebar_mini_active == true) {
                                                                                                                  $('body').removeClass('sidebar-mini');
                                                                                                                  sidebar_mini_active = false;
                                                                                                                  blackDashboard.showSidebarMessage('Sidebar mini deactivated...');
                                                                                                                } else {
                                                                                                                  $('body').addClass('sidebar-mini');
                                                                                                                  sidebar_mini_active = true;
                                                                                                                  blackDashboard.showSidebarMessage('Sidebar mini activated...');
                                                                                                                }

                                                                                                                // we simulate the window Resize so the charts will get updated in realtime.
                                                                                                                var simulateWindowResize = setInterval(function () {
                                                                                                                  window.dispatchEvent(new Event('resize'));
                                                                                                                }, 180);

                                                                                                                // we stop the simulation of Window Resize after the animations are completed
                                                                                                                setTimeout(function () {
                                                                                                                  clearInterval(simulateWindowResize);
                                                                                                                }, 1000);
                                                                                                              });

                                                                                                              $('.switch-change-color input').on("switchChange.bootstrapSwitch", function () {
                                                                                                                var $btn = $(this);

                                                                                                                if (white_color == true) {

                                                                                                                  $('body').addClass('change-background');
                                                                                                                  setTimeout(function () {
                                                                                                                    $('body').removeClass('change-background');
                                                                                                                    $('body').removeClass('white-content');
                                                                                                                  }, 900);
                                                                                                                  white_color = false;
                                                                                                                } else {

                                                                                                                  $('body').addClass('change-background');
                                                                                                                  setTimeout(function () {
                                                                                                                    $('body').removeClass('change-background');
                                                                                                                    $('body').addClass('white-content');
                                                                                                                  }, 900);

                                                                                                                  white_color = true;
                                                                                                                }

                                                                                                              });

                                                                                                              $('.light-badge').click(function () {
                                                                                                                $('body').addClass('white-content');
                                                                                                              });

                                                                                                              $('.dark-badge').click(function () {
                                                                                                                $('body').removeClass('white-content');
                                                                                                              });
                                                                                                            });
                                                                                                          });
                                                                                                        </script>



                                                                                                      </body>

                                                                                                    </html>
